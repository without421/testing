#!/bin/bash

TRANS_PORT="9040"
DNS_PORT="5353"
PIDFILE="/run/mytor.pid"

check_status() {
    # Check if actually running, not just PID file
    if ! systemctl is-active --quiet tor; then
        [ -f "$PIDFILE" ] && sudo rm -f "$PIDFILE"
        echo "Status: [INACTIVE]"
        return 2
    fi
    
    PROGRESS=$(sudo journalctl -u tor --since "2 minutes ago" --no-pager | grep "Bootstrapped" | tail -1 | grep -oP '\d+%' || echo "0%")
    
    if [ "$PROGRESS" = "100%" ]; then
        IP=$(curl --socks5-hostname 127.0.0.1:9050 -s https://check.torproject.org/api/ip 2>/dev/null | grep -oP '"IP":"\K[^"]+' || echo "unknown")
        echo "Status: [CONNECTED] (100%)"
        echo "Exit IP: $IP"
        return 0
    else
        echo "Status: [BOOTSTRAPPING] ($PROGRESS)"
        return 1
    fi
}

case "$1" in
    start|"")
        # Check existing status first
        if systemctl is-active --quiet tor; then
            echo "Tor is already running."
            check_status
            exit 0
        fi

        echo "Starting Tor service..."
        sudo systemctl start tor || { echo "Failed to start Tor"; exit 1; }
        
        echo "Waiting for bootstrap (Ctrl+C to background)..."
        echo "------------------------------------------------"
        
        # Use timeout to avoid infinite hang
        timeout 60 sudo journalctl -u tor -f --since "5 seconds ago" | while read -r line; do
            echo "$line"
            
            # Check for errors
            if echo "$line" | grep -qiE "(error|failed|unable to|exiting)"; then
                echo "------------------------------------------------"
                echo "✗ ERROR: Tor bootstrap failed!"
                sudo systemctl stop tor
                exit 1
            fi
            
            if echo "$line" | grep -q "Bootstrapped 100%"; then
                echo "------------------------------------------------"
                echo "✓ DONE: Applying firewall rules..."
                
                sudo iptables -F
                sudo iptables -t nat -F
                
                # ADD BACK: localhost bypass (critical!)
                sudo iptables -t nat -A OUTPUT -d 127.0.0.1/32 -j RETURN
                sudo iptables -t nat -A OUTPUT -m owner --uid-owner tor -j RETURN
                sudo iptables -t nat -A OUTPUT -p udp --dport 53 -j REDIRECT --to-ports $DNS_PORT
                sudo iptables -t nat -A OUTPUT -p tcp --syn -j REDIRECT --to-ports $TRANS_PORT
                sudo iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
                
                # Mark as active
                echo "active" | sudo tee "$PIDFILE" > /dev/null
                
                echo "✓ SUCCESS: All traffic is now tunneled."
                echo "Run 'mytor stop' to disconnect."
                
                # Kill journalctl cleanly
                pkill -P $$ journalctl 2>/dev/null
                exit 0
            fi
        done
        
        # If we get here, either timeout or Ctrl+C
        if systemctl is-active --quiet tor; then
            echo ""
            echo "Bootstrap incomplete or interrupted. Tor still running."
            echo "Run 'mytor status' to check progress."
        fi
        ;;

    stop)
        if [ ! -f "$PIDFILE" ] && ! systemctl is-active --quiet tor; then
            echo "Tor is not running."
            exit 0
        fi
        
        echo "Restoring normal traffic..."
        sudo iptables -F
        sudo iptables -t nat -F
        sudo systemctl stop tor
        sudo rm -f "$PIDFILE"
        echo "✓ Tor stopped and firewall cleared."
        ;;

    status)
        check_status
        ;;

    *)
        echo "Usage: mytor [start|stop|status]"
        exit 1
        ;;
esac
